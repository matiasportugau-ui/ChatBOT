version: "3.9"

networks:
  auto-atc-network:
    driver: bridge

secrets:
  postgres_password:
    file: ./.secrets/postgres_password.txt
  redis_password:
    file: ./.secrets/redis_password.txt

services:
  traefik:
    image: traefik:v3.0
    command:
      - --providers.docker=true
      - --entrypoints.web.address=:80
      - --api.insecure=true
    ports: ["80:80", "8080:8080"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - auto-atc-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "traefik", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3

  chatwoot:
    image: chatwoot/chatwoot:latest
    env_file: .env.chatwoot
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports: ["3000:3000"]
    volumes:
      - ./chatwoot_storage:/app/storage
      - ./chatwoot_public:/app/public
    networks:
      - auto-atc-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: atc_user
      POSTGRES_DB: atc_db
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    secrets:
      - postgres_password
    volumes:
      - ./pgdata:/var/lib/postgresql/data
      - ./db/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    ports: ["5432:5432"]
    networks:
      - auto-atc-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U atc_user -d atc_db"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    image: redis:7-alpine
    command: redis-server --requirepass "$(cat /run/secrets/redis_password)"
    secrets:
      - redis_password
    volumes:
      - ./redis_data:/data
    ports: ["6379:6379"]
    networks:
      - auto-atc-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  n8n:
    image: n8nio/n8n:latest
    env_file: .env.n8n
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports: ["5678:5678"]
    volumes:
      - ./n8n_data:/home/node/.n8n
    networks:
      - auto-atc-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

  rasa:
    image: rasa/rasa:3.6.20-full
    command: ["run", "--enable-api", "--cors", "*", "--port", "5005", "--debug"]
    volumes:
      - ./rasa:/app
    ports: ["5005:5005"]
    networks:
      - auto-atc-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5005/"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - qdrant

  qdrant:
    image: qdrant/qdrant:latest
    ports: ["6333:6333", "6334:6334"]
    volumes:
      - ./qdrant_storage:/qdrant/storage
    networks:
      - auto-atc-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3

# EXPORT_SEAL v1
# project: auto-atc
# prompt_id: infra-v3
# version: 3.0.0
# file: docker-compose.yml
# lang: yaml
# created_at: 2025-10-31T00:10:55Z
# author: GPT-5 Thinking
# origin: infra-blueprint
# body_sha256: df982c2b305fa843621da975c39d1f369c165b10caab866192e76bf8b4a68b32
